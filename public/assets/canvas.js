(function(a){function c(c,j,i){var h=l[c];n=a("#"+h.id).find("ul:first").clone(!0);n.css(h.menuStyle).find("li").css(h.itemStyle).hover(function(){a(this).css(h.itemHoverStyle)},function(){a(this).css(h.itemStyle)}).find("img").css({verticalAlign:"middle",paddingRight:"2px"});g.html(n);h.onShowMenu&&(g=h.onShowMenu(i,g));a.each(h.bindings,function(c,h){a("#"+c,g).bind("click",function(){f();h(j,o)})});g.css({left:i[h.eventPosX],top:i[h.eventPosY]}).show();h.shadow&&k.css({width:g.width(),height:g.height(),
left:i.pageX+2,top:i.pageY+2}).show();a(document).one("click",f)}function f(){g.hide();k.hide()}var g,k,n,l,o,i={menuStyle:{listStyle:"none",padding:"1px",margin:"0px",backgroundColor:"#fff",border:"1px solid #999",width:"100px"},itemStyle:{margin:"0px",color:"#000",display:"block",cursor:"default",padding:"3px",border:"1px solid #fff",backgroundColor:"transparent"},itemHoverStyle:{border:"1px solid #0a246a",backgroundColor:"#b6bdd2"},eventPosX:"pageX",eventPosY:"pageY",shadow:!0,onContextMenu:null,
onShowMenu:null};a.fn.contextMenu=function(f,j){g||(g=a('<div id="jqContextMenu"></div>').hide().css({position:"absolute",zIndex:"500"}).appendTo("body").bind("click",function(a){a.stopPropagation()}));k||(k=a("<div></div>").css({backgroundColor:"#000",position:"absolute",opacity:0.2,zIndex:499}).appendTo("body").hide());l=l||[];l.push({id:f,menuStyle:a.extend({},i.menuStyle,j.menuStyle||{}),itemStyle:a.extend({},i.itemStyle,j.itemStyle||{}),itemHoverStyle:a.extend({},i.itemHoverStyle,j.itemHoverStyle||
{}),bindings:j.bindings||{},shadow:j.shadow||j.shadow===!1?j.shadow:i.shadow,onContextMenu:j.onContextMenu||i.onContextMenu,onShowMenu:j.onShowMenu||i.onShowMenu,eventPosX:j.eventPosX||i.eventPosX,eventPosY:j.eventPosY||i.eventPosY});var r=l.length-1;a(this).bind("contextmenu",function(a){(l[r].onContextMenu?l[r].onContextMenu(a):1)&&c(r,this,a,j);return!1});return this};a.contextMenu={defaults:function(f){a.each(f,function(f,c){typeof c=="object"&&i[f]?a.extend(i[f],c):i[f]=c})}}})(jQuery);$(function(){$("div.contextMenu").hide()});
(function(a){function c(a){for(var c=["transform","WebkitTransform","MozTransform","msTransform","OTransform"],k;k=c.shift();)if(a.style[k]!==void 0)return k;return!1}a.cssHooks.rotate={get:function(a){var g=c(a);return g?a.style[g].replace(/.*rotate\((.*)deg\).*/,"$1"):""},set:function(f,g){var k=c(f);if(k)g=parseInt(g),a(f).data("rotatation",g),f.style[k]=g==0?"":"rotate("+g%360+"deg)";else return""}};a.fx.step.rotate=function(c){a.cssHooks.rotate.set(c.elem,c.now)}})(jQuery);
(function(a){var c=function(){var c=65,g={eventName:"click",onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},color:"ff0000",livePreview:!0,flat:!1},k=function(b,d){var e=m(b);a(d).data("colorpicker").fields.eq(1).val(e.r).end().eq(2).val(e.g).end().eq(3).val(e.b).end()},n=function(b,d){a(d).data("colorpicker").fields.eq(4).val(b.h).end().eq(5).val(b.s).end().eq(6).val(b.b).end()},l=function(b,d){a(d).data("colorpicker").fields.eq(0).val(p(m(b))).end()},
o=function(b,d){a(d).data("colorpicker").selector.css("backgroundColor","#"+p(m({h:b.h,s:100,b:100})));a(d).data("colorpicker").selectorIndic.css({left:parseInt(150*b.s/100,10),top:parseInt(150*(100-b.b)/100,10)})},i=function(b,d){a(d).data("colorpicker").hue.css("top",parseInt(150-150*b.h/360,10))},s=function(b,d){a(d).data("colorpicker").currentColor.css("backgroundColor","#"+p(m(b)))},j=function(b,d){a(d).data("colorpicker").newColor.css("backgroundColor","#"+p(m(b)))},r=function(b){b=b.charCode||
b.keyCode||-1;if(b>c&&b<=90||b==32)return!1;a(this).parent().parent().data("colorpicker").livePreview===!0&&h.apply(this)},h=function(b){var d=a(this).parent().parent(),e;if(this.parentNode.className.indexOf("_hex")>0){e=d.data("colorpicker");var c=this.value,f=6-c.length;if(f>0){for(var g=[],h=0;h<f;h++)g.push("0");g.push(c);c=g.join("")}c=q(t(c));e.color=e=c}else this.parentNode.className.indexOf("_hsb")>0?d.data("colorpicker").color=e=u({h:parseInt(d.data("colorpicker").fields.eq(4).val(),10),
s:parseInt(d.data("colorpicker").fields.eq(5).val(),10),b:parseInt(d.data("colorpicker").fields.eq(6).val(),10)}):(e=d.data("colorpicker"),c={r:parseInt(d.data("colorpicker").fields.eq(1).val(),10),g:parseInt(d.data("colorpicker").fields.eq(2).val(),10),b:parseInt(d.data("colorpicker").fields.eq(3).val(),10)},e.color=e=q({r:Math.min(255,Math.max(0,c.r)),g:Math.min(255,Math.max(0,c.g)),b:Math.min(255,Math.max(0,c.b))}));b&&(k(e,d.get(0)),l(e,d.get(0)),n(e,d.get(0)));o(e,d.get(0));i(e,d.get(0));j(e,
d.get(0));d.data("colorpicker").onChange.apply(d,[e,p(m(e)),m(e)])},D=function(){a(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus")},E=function(){c=this.parentNode.className.indexOf("_hex")>0?70:65;a(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus");a(this).parent().addClass("colorpicker_focus")},F=function(b){var d=a(this).parent().find("input").focus();b={el:a(this).parent().addClass("colorpicker_slider"),max:this.parentNode.className.indexOf("_hsb_h")>
0?360:this.parentNode.className.indexOf("_hsb")>0?100:255,y:b.pageY,field:d,val:parseInt(d.val(),10),preview:a(this).parent().parent().data("colorpicker").livePreview};a(document).bind("mouseup",b,v);a(document).bind("mousemove",b,w)},w=function(b){b.data.field.val(Math.max(0,Math.min(b.data.max,parseInt(b.data.val+b.pageY-b.data.y,10))));b.data.preview&&h.apply(b.data.field.get(0),[!0]);return!1},v=function(b){h.apply(b.data.field.get(0),[!0]);b.data.el.removeClass("colorpicker_slider").find("input").focus();
a(document).unbind("mouseup",v);a(document).unbind("mousemove",w);return!1},G=function(){var b={cal:a(this).parent(),y:a(this).offset().top};b.preview=b.cal.data("colorpicker").livePreview;a(document).bind("mouseup",b,x);a(document).bind("mousemove",b,y)},y=function(b){h.apply(b.data.cal.data("colorpicker").fields.eq(4).val(parseInt(360*(150-Math.max(0,Math.min(150,b.pageY-b.data.y)))/150,10)).get(0),[b.data.preview]);return!1},x=function(b){k(b.data.cal.data("colorpicker").color,b.data.cal.get(0));
l(b.data.cal.data("colorpicker").color,b.data.cal.get(0));a(document).unbind("mouseup",x);a(document).unbind("mousemove",y);return!1},H=function(){var b={cal:a(this).parent(),pos:a(this).offset()};b.preview=b.cal.data("colorpicker").livePreview;a(document).bind("mouseup",b,z);a(document).bind("mousemove",b,A)},A=function(b){h.apply(b.data.cal.data("colorpicker").fields.eq(6).val(parseInt(100*(150-Math.max(0,Math.min(150,b.pageY-b.data.pos.top)))/150,10)).end().eq(5).val(parseInt(100*Math.max(0,Math.min(150,
b.pageX-b.data.pos.left))/150,10)).get(0),[b.data.preview]);return!1},z=function(b){k(b.data.cal.data("colorpicker").color,b.data.cal.get(0));l(b.data.cal.data("colorpicker").color,b.data.cal.get(0));a(document).unbind("mouseup",z);a(document).unbind("mousemove",A);return!1},I=function(){a(this).addClass("colorpicker_focus")},J=function(){a(this).removeClass("colorpicker_focus")},K=function(){var b=a(this).parent(),d=b.data("colorpicker").color;b.data("colorpicker").origColor=d;s(d,b.get(0));b.data("colorpicker").onSubmit(d,
p(m(d)),m(d),b.data("colorpicker").el)},C=function(){var b=a("#"+a(this).data("colorpickerId"));b.data("colorpicker").onBeforeShow.apply(this,[b.get(0)]);var d=a(this).offset(),e;e=document.compatMode=="CSS1Compat";e={l:window.pageXOffset||(e?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(e?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(e?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(e?
document.documentElement.clientHeight:document.body.clientHeight)};var c=d.top+this.offsetHeight;d=d.left;c+176>e.t+e.h&&(c-=this.offsetHeight+176);d+356>e.l+e.w&&(d-=356);b.css({left:d+"px",top:c+"px"});b.data("colorpicker").onShow.apply(this,[b.get(0)])!=!1&&b.show();a(document).bind("mousedown",{cal:b},B);return!1},B=function(b){L(b.data.cal.get(0),b.target,b.data.cal.get(0))||(b.data.cal.data("colorpicker").onHide.apply(this,[b.data.cal.get(0)])!=!1&&b.data.cal.hide(),a(document).unbind("mousedown",
B))},L=function(b,a,e){if(b==a)return!0;if(b.contains)return b.contains(a);if(b.compareDocumentPosition)return!!(b.compareDocumentPosition(a)&16);for(a=a.parentNode;a&&a!=e;){if(a==b)return!0;a=a.parentNode}return!1},u=function(b){return{h:Math.min(360,Math.max(0,b.h)),s:Math.min(100,Math.max(0,b.s)),b:Math.min(100,Math.max(0,b.b))}},t=function(b){b=parseInt(b.indexOf("#")>-1?b.substring(1):b,16);return{r:b>>16,g:(b&65280)>>8,b:b&255}},q=function(b){var a={h:0,s:0,b:0},e=Math.max(b.r,b.g,b.b),c=e-
Math.min(b.r,b.g,b.b);a.b=e;a.s=e!=0?255*c/e:0;a.h=a.s!=0?b.r==e?(b.g-b.b)/c:b.g==e?2+(b.b-b.r)/c:4+(b.r-b.g)/c:-1;a.h*=60;a.h<0&&(a.h+=360);a.s*=100/255;a.b*=100/255;return a},m=function(b){var a={},e=Math.round(b.h),c=Math.round(b.s*255/100);b=Math.round(b.b*255/100);if(c==0)a.r=a.g=a.b=b;else{c=(255-c)*b/255;var f=(b-c)*(e%60)/60;e==360&&(e=0);e<60?(a.r=b,a.b=c,a.g=c+f):e<120?(a.g=b,a.b=c,a.r=b-f):e<180?(a.g=b,a.r=c,a.b=c+f):e<240?(a.b=b,a.r=c,a.g=b-f):e<300?(a.b=b,a.g=c,a.r=c+f):e<360?(a.r=b,
a.g=c,a.b=b-f):(a.r=0,a.g=0,a.b=0)}return{r:Math.round(a.r),g:Math.round(a.g),b:Math.round(a.b)}},p=function(b){var d=[b.r.toString(16),b.g.toString(16),b.b.toString(16)];a.each(d,function(a,b){b.length==1&&(d[a]="0"+b)});return d.join("")},M=function(){var b=a(this).parent(),d=b.data("colorpicker").origColor;b.data("colorpicker").color=d;k(d,b.get(0));l(d,b.get(0));n(d,b.get(0));o(d,b.get(0));i(d,b.get(0));j(d,b.get(0))};return{init:function(b){b=a.extend({},g,b||{});if(typeof b.color=="string")b.color=
q(t(b.color));else if(b.color.r!=void 0&&b.color.g!=void 0&&b.color.b!=void 0)b.color=q(b.color);else if(b.color.h!=void 0&&b.color.s!=void 0&&b.color.b!=void 0)b.color=u(b.color);else return this;return this.each(function(){if(!a(this).data("colorpickerId")){var d=a.extend({},b);d.origColor=b.color;var c="collorpicker_"+parseInt(Math.random()*1E3);a(this).data("colorpickerId",c);c=a('<div class="colorpicker"><div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div></div>').attr("id",
c);d.flat?c.appendTo(this).show():c.appendTo(document.body);d.fields=c.find("input").bind("keyup",r).bind("change",h).bind("blur",D).bind("focus",E);c.find("span").bind("mousedown",F).end().find(">div.colorpicker_current_color").bind("click",M);d.selector=c.find("div.colorpicker_color").bind("mousedown",H);d.selectorIndic=d.selector.find("div div");d.el=this;d.hue=c.find("div.colorpicker_hue div");c.find("div.colorpicker_hue").bind("mousedown",G);d.newColor=c.find("div.colorpicker_new_color");d.currentColor=
c.find("div.colorpicker_current_color");c.data("colorpicker",d);c.find("div.colorpicker_submit").bind("mouseenter",I).bind("mouseleave",J).bind("click",K);k(d.color,c.get(0));n(d.color,c.get(0));l(d.color,c.get(0));i(d.color,c.get(0));o(d.color,c.get(0));s(d.color,c.get(0));j(d.color,c.get(0));d.flat?c.css({position:"relative",display:"block"}):a(this).bind(d.eventName,C)}})},showPicker:function(){return this.each(function(){a(this).data("colorpickerId")&&C.apply(this)})},hidePicker:function(){return this.each(function(){a(this).data("colorpickerId")&&
a("#"+a(this).data("colorpickerId")).hide()})},setColor:function(b){if(typeof b=="string")b=q(t(b));else if(b.r!=void 0&&b.g!=void 0&&b.b!=void 0)b=q(b);else if(b.h!=void 0&&b.s!=void 0&&b.b!=void 0)b=u(b);else return this;return this.each(function(){if(a(this).data("colorpickerId")){var c=a("#"+a(this).data("colorpickerId"));c.data("colorpicker").color=b;c.data("colorpicker").origColor=b;k(b,c.get(0));n(b,c.get(0));l(b,c.get(0));i(b,c.get(0));o(b,c.get(0));s(b,c.get(0));j(b,c.get(0))}})}}}();a.fn.extend({ColorPicker:c.init,
ColorPickerHide:c.hidePicker,ColorPickerShow:c.showPicker,ColorPickerSetColor:c.setColor})})(jQuery);var undoStack=[],redoStack=[],unsavedCount=0,timeout=null;$(document).ready(load);$(init);
function init(){$(".textbox").resizable({handles:"e, w"});$(".widget").draggable({grid:[10,10],start:action,stop:save}).resizable({minHeight:20,minWidth:20,grid:10,start:action,stop:save}).contextMenu("contextMenu",{bindings:{edit:editWidget,cut:cutWidget,copy:copyWidget,"delete":delWidget,front:front,forward:forward,backward:backward,back:back,rotate:rotate}}).dblclick(function(){editWidget(this)}).attr("title","Double-click to edit");$(".label, .link, .menu, .checkbox, .radio").resizable("destroy");
order()}
function load(){$("#editDialog").dialog({autoOpen:!1,modal:!0,width:400,height:270,title:"Edit Widget",buttons:{OK:function(){action();$(globalWidget).hasClass("checkbox")||$(globalWidget).hasClass("radio")?$("#checked").attr("checked")==!0?$(globalWidget).children(".text").text("\u2713"):$(globalWidget).children(".text").text(""):($(globalWidget).children(".text").text($("#widgetTxt").val()),$("#bold").attr("checked")==!0?$(globalWidget).css("font-weight","bold"):$(globalWidget).css("font-weight",""),
$("#italic").attr("checked")==!0?$(globalWidget).css("font-style","italic"):$(globalWidget).css("font-style",""),$("#underline").attr("checked")==!0?$(globalWidget).css("text-decoration","underline"):$(globalWidget).css("text-decoration",""),newSize=$("#fontsize").val(),newSize!=""&&(newSize.match(/^\d+$/)?$(globalWidget).css("font-size",newSize+"px"):alert("Please enter a valid number.")),$(globalWidget).css("text-align",$("#textalign").val()));$(globalWidget).css("color",$("#forecolor").val());
$(globalWidget).css("background-color",$("#backcolor").val());save();$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});$("#forecolor").ColorPicker({onChange:function(a,c){$("#forecolor").val("#"+c)},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)}});$("#backcolor").ColorPicker({onChange:function(a,c){$("#backcolor").val("#"+c)},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)}});$(".ui-dialog").live("keyup",function(a){a.which==13&&$(':button:contains("OK")').click()});
setData(JSON.parse(localStorage.data));undoStack=[];redoStack=[]}
function editWidget(a){$(a).hasClass("checkbox")||$(a).hasClass("radio")?($("#widgetTxt, #widgetTxtLbl, #bold, #boldLbl, #italic, #italicLbl, #underline, #underlineLbl, #fontsize, #fontsizeLbl, #textalign, #textalignLbl").hide(),$("#checked, #checkedLbl").show(),$("#checked").attr("checked",$(a).children(".text").text()=="\u2713")):($("#widgetTxt, #widgetTxtLbl, #bold, #boldLbl, #italic, #italicLbl, #underline, #underlineLbl, #fontsize, #fontsizeLbl, #textalign, #textalignLbl").show(),$("#widgetTxt").val($(a).children(".text").text()),
$("#checked, #checkedLbl").hide(),$("#bold").attr("checked",$(a).css("font-weight")==700||$(a).css("font-weight")=="bold"),$("#italic").attr("checked",$(a).css("font-style")=="italic"),$("#underline").attr("checked",$(a).css("text-decoration")=="underline"),$("#fontsize").val($(a).css("font-size").replace(/px|pt|em|%/,"")),$("#textalign").val($(a).css("text-align")));$("#forecolor").val(rgbToHex($(a).css("color")));$("#backcolor").val(rgbToHex($(a).css("background-color")));globalWidget=a;$("#editDialog").dialog("open")}
function cutWidget(a){action();setClipboard(a);$(a).remove();save()}function copyWidget(a){setClipboard(a)}function pasteWidget(){parent.clipboard.set==!0&&(action(),add(parent.clipboard.className,parent.clipboard.text,parent.clipboard.style),init(),save())}function delWidget(a){action();$(a).remove();save()}function front(a){action();$(a).appendTo($("#canvas"));order();save()}function forward(a){action();$(a).insertAfter($(a).next(".widget"));order();save()}
function backward(a){action();$(a).insertBefore($(a).prev(".widget"));order();save()}function back(a){action();$(a).prependTo("#canvas");order();save()}function rotate(a){action();currentRotation=$(a).css("rotate")==""?0:parseInt($(a).css("rotate"));$(a).css("rotate",currentRotation+90);save()}function order(){$(".widget").each(function(a){$(this).css("z-index",a)})}function clear(){$("#canvas").empty()}
function add(a,c,f){$("#canvas").append("<div class='widget "+a+"' style='"+f+"'><div class='text'>"+c+"</div></div>")}function action(){undoStack.push(getData())}function undo(){if(undoStack.length!=0){redoStack.push(getData());var a=undoStack.pop();setData(a);save()}}function redo(){if(redoStack.length!=0){undoStack.push(getData());var a=redoStack.pop();setData(a);save()}}
function save(a,c){a!=!0&&(a=!1);c!=!0&&(c=!1);a==!0&&(c=!0);c?unsavedCount<1||(id=parent.document.location.href.split("/").pop(),$.ajax({url:"/save",type:"POST",async:!a,data:{id:id,data:JSON.stringify(getData())},beforeSend:function(a){a.setRequestHeader("X-authenticity_token",$('meta[name="csrf-token"]').attr("content"))},success:function(a){a==" "?(parent.saved(),unsavedCount=0):parent.saveFailed()},error:function(){parent.saveFailed()}})):(unsavedCount++,timeout&&clearTimeout(timeout),timeout=
setTimeout("save(false, true)",2500))}function getData(){var a={};$(".widget").each(function(c){var f={};f["class"]=$(this).attr("class").split(" ")[1];f.text=$(this).children(".text").html();f.style=$(this).attr("style");a[c]=f});return a}function setData(a){clear();$.each(a,function(a,f){add(f["class"],f.text,f.style)});init()}
function setClipboard(a){parent.clipboard.className=$(a).attr("class").split(" ")[1];parent.clipboard.text=$(a).children(".text").html();parent.clipboard.style=$(a).attr("style");parent.clipboard.set=!0}function rgbToHex(a){if(a.search("rgb")==-1)return a;else{a=a.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);var c=function(a){return("0"+parseInt(a).toString(16)).slice(-2)};return"#"+c(a[1])+c(a[2])+c(a[3])}};
