(function(f){var a,j,c,h,e,b;var d={menuStyle:{listStyle:"none",padding:"1px",margin:"0px",backgroundColor:"#fff",border:"1px solid #999",width:"100px"},itemStyle:{margin:"0px",color:"#000",display:"block",cursor:"default",padding:"3px",border:"1px solid #fff",backgroundColor:"transparent"},itemHoverStyle:{border:"1px solid #0a246a",backgroundColor:"#b6bdd2"},eventPosX:"pageX",eventPosY:"pageY",shadow:true,onContextMenu:null,onShowMenu:null};f.fn.contextMenu=function(m,l){if(!a){a=f('<div id="jqContextMenu"></div>').hide().css({position:"absolute",zIndex:"500"}).appendTo("body").bind("click",function(n){n.stopPropagation()})}if(!j){j=f("<div></div>").css({backgroundColor:"#000",position:"absolute",opacity:0.2,zIndex:499}).appendTo("body").hide()}e=e||[];e.push({id:m,menuStyle:f.extend({},d.menuStyle,l.menuStyle||{}),itemStyle:f.extend({},d.itemStyle,l.itemStyle||{}),itemHoverStyle:f.extend({},d.itemHoverStyle,l.itemHoverStyle||{}),bindings:l.bindings||{},shadow:l.shadow||l.shadow===false?l.shadow:d.shadow,onContextMenu:l.onContextMenu||d.onContextMenu,onShowMenu:l.onShowMenu||d.onShowMenu,eventPosX:l.eventPosX||d.eventPosX,eventPosY:l.eventPosY||d.eventPosY});var k=e.length-1;f(this).bind("contextmenu",function(o){var n=(!!e[k].onContextMenu)?e[k].onContextMenu(o):true;if(n){i(k,this,o,l)}return false});return this};function i(m,l,n,k){var o=e[m];h=f("#"+o.id).find("ul:first").clone(true);h.css(o.menuStyle).find("li").css(o.itemStyle).hover(function(){f(this).css(o.itemHoverStyle)},function(){f(this).css(o.itemStyle)}).find("img").css({verticalAlign:"middle",paddingRight:"2px"});a.html(h);if(!!o.onShowMenu){a=o.onShowMenu(n,a)}f.each(o.bindings,function(q,p){f("#"+q,a).bind("click",function(r){g();p(l,b)})});a.css({left:n[o.eventPosX],top:n[o.eventPosY]}).show();if(o.shadow){j.css({width:a.width(),height:a.height(),left:n.pageX+2,top:n.pageY+2}).show()}f(document).one("click",g)}function g(){a.hide();j.hide()}f.contextMenu={defaults:function(k){f.each(k,function(l,m){if(typeof m=="object"&&d[l]){f.extend(d[l],m)}else{d[l]=m}})}}})(jQuery);$(function(){$("div.contextMenu").hide()});(function(b){function a(e){for(var d=["transform","WebkitTransform","MozTransform","msTransform","OTransform"],f;f=d.shift();){if(e.style[f]!==undefined){return f}}return false}b.cssHooks.rotate={get:function(d){var c=a(d);return c?d.style[c].replace(/.*rotate\((.*)deg\).*/,"$1"):""},set:function(e,d){var f=a(e);if(f){d=parseInt(d);b(e).data("rotatation",d);e.style[f]=d==0?"":"rotate("+d%360+"deg)"}else{return""}}};b.fx.step.rotate=function(c){b.cssHooks.rotate.set(c.elem,c.now)}})(jQuery);(function(b){var a=function(){var Y=65,aa={eventName:"click",onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},color:"ff0000",livePreview:true,flat:false},aq=function(h,f){var i=ar(h);b(f).data("colorpicker").fields.eq(1).val(i.r).end().eq(2).val(i.g).end().eq(3).val(i.b).end()},al=function(h,f){b(f).data("colorpicker").fields.eq(4).val(h.h).end().eq(5).val(h.s).end().eq(6).val(h.b).end()},ao=function(h,f){b(f).data("colorpicker").fields.eq(0).val(ap(ar(h))).end()},ak=function(h,f){b(f).data("colorpicker").selector.css("backgroundColor","#"+ap(ar({h:h.h,s:100,b:100})));b(f).data("colorpicker").selectorIndic.css({left:parseInt(150*h.s/100,10),top:parseInt(150*(100-h.b)/100,10)})},aj=function(h,f){b(f).data("colorpicker").hue.css("top",parseInt(150-150*h.h/360,10))},af=function(h,f){b(f).data("colorpicker").currentColor.css("backgroundColor","#"+ap(ar(h)))},ai=function(h,f){b(f).data("colorpicker").newColor.css("backgroundColor","#"+ap(ar(h)))},X=function(f){f=f.charCode||f.keyCode||-1;if(f>Y&&f<=90||f==32){return false}b(this).parent().parent().data("colorpicker").livePreview===true&&an.apply(this)},an=function(i){var f=b(this).parent().parent(),m;if(this.parentNode.className.indexOf("_hex")>0){m=f.data("colorpicker");var l=this.value,k=6-l.length;if(k>0){for(var j=[],h=0;h<k;h++){j.push("0")}j.push(l);l=j.join("")}l=am(ab(l));m.color=m=l}else{if(this.parentNode.className.indexOf("_hsb")>0){f.data("colorpicker").color=m=Z({h:parseInt(f.data("colorpicker").fields.eq(4).val(),10),s:parseInt(f.data("colorpicker").fields.eq(5).val(),10),b:parseInt(f.data("colorpicker").fields.eq(6).val(),10)})}else{m=f.data("colorpicker");l={r:parseInt(f.data("colorpicker").fields.eq(1).val(),10),g:parseInt(f.data("colorpicker").fields.eq(2).val(),10),b:parseInt(f.data("colorpicker").fields.eq(3).val(),10)};m.color=m=am({r:Math.min(255,Math.max(0,l.r)),g:Math.min(255,Math.max(0,l.g)),b:Math.min(255,Math.max(0,l.b))})}}if(i){aq(m,f.get(0));ao(m,f.get(0));al(m,f.get(0))}ak(m,f.get(0));aj(m,f.get(0));ai(m,f.get(0));f.data("colorpicker").onChange.apply(f,[m,ap(ar(m)),ar(m)])},W=function(){b(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus")},U=function(){Y=this.parentNode.className.indexOf("_hex")>0?70:65;b(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus");b(this).parent().addClass("colorpicker_focus")},S=function(h){var f=b(this).parent().find("input").focus();h={el:b(this).parent().addClass("colorpicker_slider"),max:this.parentNode.className.indexOf("_hsb_h")>0?360:this.parentNode.className.indexOf("_hsb")>0?100:255,y:h.pageY,field:f,val:parseInt(f.val(),10),preview:b(this).parent().parent().data("colorpicker").livePreview};b(document).bind("mouseup",h,V);b(document).bind("mousemove",h,T)},T=function(f){f.data.field.val(Math.max(0,Math.min(f.data.max,parseInt(f.data.val+f.pageY-f.data.y,10))));f.data.preview&&an.apply(f.data.field.get(0),[true]);return false},V=function(f){an.apply(f.data.field.get(0),[true]);f.data.el.removeClass("colorpicker_slider").find("input").focus();b(document).unbind("mouseup",V);b(document).unbind("mousemove",T);return false},R=function(){var f={cal:b(this).parent(),y:b(this).offset().top};f.preview=f.cal.data("colorpicker").livePreview;b(document).bind("mouseup",f,w);b(document).bind("mousemove",f,ah)},ah=function(f){an.apply(f.data.cal.data("colorpicker").fields.eq(4).val(parseInt(360*(150-Math.max(0,Math.min(150,f.pageY-f.data.y)))/150,10)).get(0),[f.data.preview]);return false},w=function(f){aq(f.data.cal.data("colorpicker").color,f.data.cal.get(0));ao(f.data.cal.data("colorpicker").color,f.data.cal.get(0));b(document).unbind("mouseup",w);b(document).unbind("mousemove",ah);return false},s=function(){var f={cal:b(this).parent(),pos:b(this).offset()};f.preview=f.cal.data("colorpicker").livePreview;b(document).bind("mouseup",f,ag);b(document).bind("mousemove",f,ae)},ae=function(f){an.apply(f.data.cal.data("colorpicker").fields.eq(6).val(parseInt(100*(150-Math.max(0,Math.min(150,f.pageY-f.data.pos.top)))/150,10)).end().eq(5).val(parseInt(100*Math.max(0,Math.min(150,f.pageX-f.data.pos.left))/150,10)).get(0),[f.data.preview]);return false},ag=function(f){aq(f.data.cal.data("colorpicker").color,f.data.cal.get(0));ao(f.data.cal.data("colorpicker").color,f.data.cal.get(0));b(document).unbind("mouseup",ag);b(document).unbind("mousemove",ae);return false},q=function(){b(this).addClass("colorpicker_focus")},g=function(){b(this).removeClass("colorpicker_focus")},e=function(){var h=b(this).parent(),f=h.data("colorpicker").color;h.data("colorpicker").origColor=f;af(f,h.get(0));h.data("colorpicker").onSubmit(f,ap(ar(f)),ar(f),h.data("colorpicker").el)},ac=function(){var h=b("#"+b(this).data("colorpickerId"));h.data("colorpicker").onBeforeShow.apply(this,[h.get(0)]);var f=b(this).offset(),j;j=document.compatMode=="CSS1Compat";j={l:window.pageXOffset||(j?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(j?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(j?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(j?document.documentElement.clientHeight:document.body.clientHeight)};var i=f.top+this.offsetHeight;f=f.left;if(i+176>j.t+j.h){i-=this.offsetHeight+176}if(f+356>j.l+j.w){f-=356}h.css({left:f+"px",top:i+"px"});h.data("colorpicker").onShow.apply(this,[h.get(0)])!=false&&h.show();b(document).bind("mousedown",{cal:h},ad);return false},ad=function(f){if(!d(f.data.cal.get(0),f.target,f.data.cal.get(0))){f.data.cal.data("colorpicker").onHide.apply(this,[f.data.cal.get(0)])!=false&&f.data.cal.hide();b(document).unbind("mousedown",ad)}},d=function(h,f,i){if(h==f){return true}if(h.contains){return h.contains(f)}if(h.compareDocumentPosition){return !!(h.compareDocumentPosition(f)&16)}for(f=f.parentNode;f&&f!=i;){if(f==h){return true}f=f.parentNode}return false},Z=function(f){return{h:Math.min(360,Math.max(0,f.h)),s:Math.min(100,Math.max(0,f.s)),b:Math.min(100,Math.max(0,f.b))}},ab=function(f){f=parseInt(f.indexOf("#")>-1?f.substring(1):f,16);return{r:f>>16,g:(f&65280)>>8,b:f&255}},am=function(h){var f={h:0,s:0,b:0},j=Math.max(h.r,h.g,h.b),i=j-Math.min(h.r,h.g,h.b);f.b=j;f.s=j!=0?255*i/j:0;f.h=f.s!=0?h.r==j?(h.g-h.b)/i:h.g==j?2+(h.b-h.r)/i:4+(h.r-h.g)/i:-1;f.h*=60;if(f.h<0){f.h+=360}f.s*=100/255;f.b*=100/255;return f},ar=function(h){var f={},k=Math.round(h.h),j=Math.round(h.s*255/100);h=Math.round(h.b*255/100);if(j==0){f.r=f.g=f.b=h}else{j=(255-j)*h/255;var i=(h-j)*(k%60)/60;if(k==360){k=0}if(k<60){f.r=h;f.b=j;f.g=j+i}else{if(k<120){f.g=h;f.b=j;f.r=h-i}else{if(k<180){f.g=h;f.r=j;f.b=j+i}else{if(k<240){f.b=h;f.r=j;f.g=h-i}else{if(k<300){f.b=h;f.g=j;f.r=j+i}else{if(k<360){f.r=h;f.g=j;f.b=h-i}else{f.r=0;f.g=0;f.b=0}}}}}}}return{r:Math.round(f.r),g:Math.round(f.g),b:Math.round(f.b)}},ap=function(h){var f=[h.r.toString(16),h.g.toString(16),h.b.toString(16)];b.each(f,function(j,i){if(i.length==1){f[j]="0"+i}});return f.join("")},c=function(){var h=b(this).parent(),f=h.data("colorpicker").origColor;h.data("colorpicker").color=f;aq(f,h.get(0));ao(f,h.get(0));al(f,h.get(0));ak(f,h.get(0));aj(f,h.get(0));ai(f,h.get(0))};return{init:function(f){f=b.extend({},aa,f||{});if(typeof f.color=="string"){f.color=am(ab(f.color))}else{if(f.color.r!=undefined&&f.color.g!=undefined&&f.color.b!=undefined){f.color=am(f.color)}else{if(f.color.h!=undefined&&f.color.s!=undefined&&f.color.b!=undefined){f.color=Z(f.color)}else{return this}}}return this.each(function(){if(!b(this).data("colorpickerId")){var h=b.extend({},f);h.origColor=f.color;var i="collorpicker_"+parseInt(Math.random()*1000);b(this).data("colorpickerId",i);i=b('<div class="colorpicker"><div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div></div>').attr("id",i);h.flat?i.appendTo(this).show():i.appendTo(document.body);h.fields=i.find("input").bind("keyup",X).bind("change",an).bind("blur",W).bind("focus",U);i.find("span").bind("mousedown",S).end().find(">div.colorpicker_current_color").bind("click",c);h.selector=i.find("div.colorpicker_color").bind("mousedown",s);h.selectorIndic=h.selector.find("div div");h.el=this;h.hue=i.find("div.colorpicker_hue div");i.find("div.colorpicker_hue").bind("mousedown",R);h.newColor=i.find("div.colorpicker_new_color");h.currentColor=i.find("div.colorpicker_current_color");i.data("colorpicker",h);i.find("div.colorpicker_submit").bind("mouseenter",q).bind("mouseleave",g).bind("click",e);aq(h.color,i.get(0));al(h.color,i.get(0));ao(h.color,i.get(0));aj(h.color,i.get(0));ak(h.color,i.get(0));af(h.color,i.get(0));ai(h.color,i.get(0));h.flat?i.css({position:"relative",display:"block"}):b(this).bind(h.eventName,ac)}})},showPicker:function(){return this.each(function(){b(this).data("colorpickerId")&&ac.apply(this)})},hidePicker:function(){return this.each(function(){b(this).data("colorpickerId")&&b("#"+b(this).data("colorpickerId")).hide()})},setColor:function(f){if(typeof f=="string"){f=am(ab(f))}else{if(f.r!=undefined&&f.g!=undefined&&f.b!=undefined){f=am(f)}else{if(f.h!=undefined&&f.s!=undefined&&f.b!=undefined){f=Z(f)}else{return this}}}return this.each(function(){if(b(this).data("colorpickerId")){var h=b("#"+b(this).data("colorpickerId"));h.data("colorpicker").color=f;h.data("colorpicker").origColor=f;aq(f,h.get(0));al(f,h.get(0));ao(f,h.get(0));aj(f,h.get(0));ak(f,h.get(0));af(f,h.get(0));ai(f,h.get(0))}})}}}();b.fn.extend({ColorPicker:a.init,ColorPickerHide:a.hidePicker,ColorPickerShow:a.showPicker,ColorPickerSetColor:a.setColor})})(jQuery);var undoStack=[];var redoStack=[];var unsavedCount=0;$(document).ready(load);$(init);function init(){$(".textbox").resizable({handles:"e, w"});$(".widget").draggable({grid:[10,10],start:action,stop:save}).resizable({minHeight:20,minWidth:20,grid:10,start:action,stop:save,resize:function(){percentToPx(this)}}).contextMenu("contextMenu",{bindings:{edit:editWidget,cut:cutWidget,copy:copyWidget,"delete":delWidget,front:front,forward:forward,backward:backward,back:back,rotate:rotate}}).dblclick(function(){editWidget(this)}).attr("title","Double-click to edit");$(".label, .link, .menu, .checkbox, .radio").resizable("destroy");percentToPx();order()}function load(){$("#editDialog").dialog({autoOpen:false,modal:true,width:400,height:270,title:"Edit Widget",buttons:{OK:function(){action();if($(globalWidget).hasClass("checkbox")||$(globalWidget).hasClass("radio")){if($("#checked").attr("checked")==true){$(globalWidget).children(".text").text("✓")}else{$(globalWidget).children(".text").text("")}}else{$(globalWidget).children(".text").text($("#widgetTxt").val());if($("#bold").attr("checked")==true){$(globalWidget).css("font-weight","bold")}else{$(globalWidget).css("font-weight","")}if($("#italic").attr("checked")==true){$(globalWidget).css("font-style","italic")}else{$(globalWidget).css("font-style","")}if($("#underline").attr("checked")==true){$(globalWidget).css("text-decoration","underline")}else{$(globalWidget).css("text-decoration","")}newSize=$("#fontsize").val();if(newSize!=""){if(!newSize.match(/^\d+$/)){alert("Please enter a valid number.")}else{$(globalWidget).css("font-size",newSize+"px")}}$(globalWidget).css("text-align",$("#textalign").val())}$(globalWidget).css("color",$("#forecolor").val());$(globalWidget).css("background-color",$("#backcolor").val());save();$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});$("#forecolor").ColorPicker({onChange:function(a,d,b,c){$("#forecolor").val("#"+d)},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)}});$("#backcolor").ColorPicker({onChange:function(a,d,b,c){$("#backcolor").val("#"+d)},onBeforeShow:function(){$(this).ColorPickerSetColor(this.value)}});$(".ui-dialog").live("keyup",function(a){if(a.which==13){$(':button:contains("OK")').click()}});setData(JSON.parse(localStorage.data));undoStack=[];redoStack=[]}function editWidget(c){var b="#checked, #checkedLbl";var a="#widgetTxt, #widgetTxtLbl, #bold, #boldLbl, #italic, #italicLbl, #underline, #underlineLbl, #fontsize, #fontsizeLbl, #textalign, #textalignLbl";if($(c).hasClass("checkbox")||$(c).hasClass("radio")){$(a).hide();$(b).show();$("#checked").attr("checked",($(c).children(".text").text()=="✓"))}else{$(a).show();$("#widgetTxt").val($(c).children(".text").text());$(b).hide();$("#bold").attr("checked",($(c).css("font-weight")==700||$(c).css("font-weight")=="bold"));$("#italic").attr("checked",($(c).css("font-style")=="italic"));$("#underline").attr("checked",($(c).css("text-decoration")=="underline"));$("#fontsize").val($(c).css("font-size").replace(/px|pt|em|%/,""));$("#textalign").val($(c).css("text-align"))}$("#forecolor").val(rgbToHex($(c).css("color")));$("#backcolor").val(rgbToHex($(c).css("background-color")));globalWidget=c;$("#editDialog").dialog("open")}function cutWidget(a){action();setClipboard(a);$(a).remove();save()}function copyWidget(a){setClipboard(a)}function pasteWidget(){if(parent.clipboard.set!=true){return}action();add(parent.clipboard.className,parent.clipboard.text,parent.clipboard.style);init();save()}function delWidget(a){action();$(a).remove();save()}function front(a){action();$(a).appendTo($("#canvas"));order();save()}function forward(a){action();$(a).insertAfter($(a).next(".widget"));order();save()}function backward(a){action();$(a).insertBefore($(a).prev(".widget"));order();save()}function back(a){action();$(a).prependTo("#canvas");order();save()}function rotate(a){action();if($(a).css("rotate")==""){currentRotation=0}else{currentRotation=parseInt($(a).css("rotate"))}$(a).css("rotate",currentRotation+90);save()}function order(){$(".widget").each(function(a){$(this).css("z-index",a)})}function clear(){$("#canvas").empty()}function add(b,c,a){$("#canvas").append("<div class='widget "+b+"' style='"+a+"'><div class='text'>"+c+"</div></div>")}function action(){undoStack.push(getData())}function undo(){if(undoStack.length==0){return}redoStack.push(getData());var a=undoStack.pop();setData(a);save()}function redo(){if(redoStack.length==0){return}undoStack.push(getData());var a=redoStack.pop();setData(a);save()}function save(a){if(a!=true){a=false}if(!a){unsavedCount++}if(unsavedCount>=5||(a==true&&unsavedCount>=1)){id=parent.document.location.href.split("/").pop();$.ajax({url:"/save",type:"POST",async:!a,data:({id:id,data:JSON.stringify(getData())}),beforeSend:function(b){b.setRequestHeader("X-authenticity_token",$('meta[name="csrf-token"]').attr("content"))},success:function(b){if(!a){if(b==" "){parent.saved();unsavedCount=0}else{parent.saveFailed()}}},error:function(){if(!a){parent.saveFailed()}}})}}function getData(){var a={};$(".widget").each(function(b){var c={};c["class"]=$(this).attr("class").split(" ")[1];c.text=$(this).children(".text").html();c.style=$(this).attr("style");a[b]=c});return a}function setData(a){clear();$.each(a,function(b,c){add(c["class"],c.text,c.style)});init()}function setClipboard(a){parent.clipboard.className=$(a).attr("class").split(" ")[1];parent.clipboard.text=$(a).children(".text").html();parent.clipboard.style=$(a).attr("style");parent.clipboard.set=true}function rgbToHex(a){if(a.search("rgb")==-1){return a}else{a=a.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);function b(c){return("0"+parseInt(c).toString(16)).slice(-2)}return"#"+b(a[1])+b(a[2])+b(a[3])}}function percentToPx(a){if(a){switch($(a).attr("class").split(" ")[1]){case"ellipse":borderRadius(this,$(this).width()/2);break;case"rounded-rectangle":borderRadius(this,$(this).width()/10);break;case"button":borderRadius(this,$(this).width()/(20/3));break}}else{$(".elipse, .radio").each(function(b){borderRadius(this,$(this).width()/2)});$(".rounded-rectangle").each(function(b){borderRadius(this,$(this).width()/10)});$(".button").each(function(b){borderRadius(this,$(this).width()/(20/3))});$(".checkbox").each(function(b){borderRadius(this,$(this).width()/20)})}}function borderRadius(b,a){$(b).css("-moz-border-radius",a);$(b).css("-webkit-border-radius",a);$(b).css("border-radius",a)};